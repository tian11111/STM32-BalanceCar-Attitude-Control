# STM32-BalanceCar-Attitude-Control
![Language](https://img.shields.io/badge/Language-C-blue)
![Platform](https://img.shields.io/badge/Platform-STM32F103-lightgrey)
![Algorithm](https://img.shields.io/badge/Algorithm-Kalman%20Filter-orange)
![Application](https://img.shields.io/badge/Application-Attitude%20Control%20for%20BalanceCar-yellow)

## 项目简介
本项目为**嵌入式竞赛实战项目**，基于STM32F103主控实现自平衡小车核心姿态控制系统，通过MPU6050六轴传感器采集三轴加速度、三轴陀螺仪原始数据，经**卡尔曼滤波算法**融合解算得到稳定的roll/pitch/yaw姿态角，结合编码器测速实现电机闭环PWM调速，配套OLED屏完成姿态数据、控制参数的实时可视化调试，实现小车自稳核心控制逻辑，代码经竞赛现场验证，具备高稳定性、实时性和工程实用性。

项目覆盖STM32裸机开发、传感器驱动、姿态解算、闭环控制等嵌入式核心考点，是自平衡小车开发的基础核心工程，可直接扩展PID自稳、无线遥控、循迹避障等高阶功能。

## 硬件系统
### 核心硬件清单
| 硬件模块               | 推荐型号                | 核心作用                          |
|------------------------|-------------------------|-----------------------------------|
| 主控板                 | STM32F103C8T6           | 外设配置、算法运算、控制逻辑执行  |
| 六轴姿态传感器         | MPU6050                 | 采集三轴加速度、三轴陀螺仪原始数据|
| 电机驱动模块           | L298N                   | 双路H桥驱动，实现电机正反转+PWM调速|
| 执行机构               | 直流减速电机×2+编码器   | 提供动力输出，采集电机转速反馈    |
| 可视化外设             | OLED12864（I2C/SPI）    | 实时显示姿态角、陀螺仪数据等参数  |
| 供电系统               | 12V锂电池+5V/3.3V稳压   | 分离供电，避免电机干扰主控稳定性  |

### 关键硬件接线（核心）
| STM32F103引脚 | 外接模块       | 功能说明                          |
|---------------|----------------|-----------------------------------|
| PB6/PB7       | MPU6050 SDA/SCL | I2C通信引脚，读取传感器原始数据    |
| TIMx_CHx引脚   | L298N IN1~IN4   | GPIO输出，控制电机正反转方向      |
| TIMx_CHx引脚   | L298N EA/EB     | PWM输出，调节电机转速（0-255级）  |
| 编码器专用引脚 | 电机编码器     | 捕获脉冲，实现转速反馈            |
| 自定义I2C/SPI  | OLED12864       | 数据可视化，实时显示核心参数      |
| GND            | 所有模块GND     | 共地连接，降低信号干扰            |

## 核心技术栈
### 软件底层开发
- STM32F103裸机开发：基于标准库实现GPIO、I2C、TIM、PWM等外设底层配置与驱动
- 软件模拟I2C协议：实现STM32与MPU6050、OLED的双向数据通信
- 定时器中断：精准控制10ms固定控制周期，保证姿态解算与电机控制的实时性
- 编码器测速：通过定时器脉冲捕获，实现电机转速的精准反馈

### 传感器与算法核心
- MPU6050全功能驱动：实现传感器初始化、寄存器配置、六轴原始数据读取
- 卡尔曼滤波算法：融合陀螺仪动态角速度与加速度计静态角度，解决陀螺仪漂移、加速度计噪声问题，输出无漂移稳定姿态角
- 姿态角解算：完成原始数据到物理量（deg/s、deg）的转换，处理角度跳变、陀螺仪死区过滤
- 闭环控制逻辑：姿态角+编码器转速双反馈，实现电机PWM调速的精准控制

### 工程化设计
- 模块化编程：将传感器驱动、滤波算法、电机控制、可视化调试解耦封装，易扩展、易调试
- 宏定义参数管理：集中配置引脚、转速、滤波参数，竞赛现场可快速调整适配赛道
- 鲁棒性设计：对姿态角、编码器数据做限幅处理，避免系统超量程失控
- 调试友好化：OLED实时显示核心参数，快速定位硬件/算法问题

## 核心功能特性
✅ **高精度姿态解算**
  - 陀螺仪原始数据→角速度（deg/s）转换，加速度计→静态roll/pitch角解算
  - 卡尔曼滤波融合动/静态数据，输出稳定roll/pitch/yaw姿态角，误差＜0.5°
  - 陀螺仪死区处理（±2°/s置0）、pitch角±90°跳变修正，提升解算稳定性

✅ **电机闭环调速控制**
  - 基于PWM实现0-255级精准调速，支持电机正反转、差速转向
  - 编码器测速反馈，结合姿态角联动调节电机转速，实现小车自稳基础
  - 转速参数限幅，避免电机堵转、失速等工程问题

✅ **实时可视化调试**
  - OLED屏实时显示roll/pitch/yaw姿态角、陀螺仪GZ原始数据、电机控制步长
  - 核心参数数字化展示，竞赛/开发中快速定位问题，提升调试效率

✅ **竞赛级工程优化**
  - 10ms固定控制周期，保证姿态解算与电机控制的实时响应
  - 电机与主控分离供电，减少电磁干扰，提升系统稳定性
  - 代码轻量化设计，占用内存少，保证STM32运行效率
  - 预留扩展接口，可快速集成PID自稳、蓝牙遥控等功能

## 关键算法实现
### 卡尔曼滤波姿态融合
核心融合陀螺仪**动态角速度**与加速度计**静态角度**，解决单一传感器的缺陷：
1. 加速度计通过反正切函数解算静态roll/pitch角：`roll_acc = atan2f(AY, AZ) * RAD2DEG`
2. 陀螺仪原始数据转换为角速度并积分，得到动态角度：`gy * dt`
3. 卡尔曼滤波通过预测、更新环节融合两者，输出无漂移稳定姿态角
4. 增加陀螺仪死区过滤、角度跳变修正，提升融合精度

### 姿态角与电机联动控制
1. 对yaw角做归一化处理，转换为0~180°范围的控制参数
2. 编码器采集电机转速并做偏移限制，补偿车体运动偏差
3. 融合姿态角与编码器偏移量，计算电机控制步长，实现PWM精准调速
4. 对控制步长做0~18限幅，避免电机超量程运行


## 竞赛/开发扩展方向
1. **PID自稳算法**：在姿态解算基础上，增加角度环、速度环双PID，实现小车完全自平衡
2. **无线遥控**：集成HC-05蓝牙模块，实现手机/遥控器对小车的方向、速度控制
3. **循迹避障**：添加红外循迹模块、超声波模块，实现自动循迹、障碍物检测与避障
4. **参数自适应**：优化卡尔曼滤波与PID参数，实现不同赛道/负载下的参数自适应
5. **多传感器融合**：增加磁力计（HMC5883L），实现姿态角的全向精准解算
6. **数据上传**：增加串口/WiFi模块，将姿态数据上传至上位机，实现远程监控与调参

